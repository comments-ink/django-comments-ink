(()=>{"use strict";class CommentForm{constructor(e){this.formWrapper=e,this.init()}click_on_post(e){return this.post("post")}click_on_preview(e){return this.post("preview")}init(){this.formWrapperEl=document.querySelector(this.formWrapper),this.formEl=this.formWrapperEl.querySelector("form");const e=this.formEl.elements.post,t=this.formEl.elements.preview;e.addEventListener("click",(e=>this.post("post"))),t.addEventListener("click",(e=>this.post("preview"))),e.type="button",t.type="button"}disable_btns(e){this.formEl.elements.post.disabled=e,this.formEl.elements.preview.disabled=e}is_valid(){for(const e of this.formEl.querySelectorAll("[required]"))if(!e.reportValidity())return e.focus(),!1;return!0}post(e){if(!this.is_valid())return;this.disable_btns(!0);const t=this.formWrapperEl.querySelector("[data-dci=preview]");t&&t.remove();const i=new FormData(this.formEl);return void 0!==e&&i.append(e,1),fetch(this.formEl.action,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:i}).then((t=>{"preview"===e?this.handle_preview_comment_response(t):"post"===e&&this.handle_post_comment_response(t)})),this.disable_btns(!1),!1}async handle_preview_comment_response(e){const t=await e.json();200===e.status?(this.formWrapperEl.innerHTML=t.html,this.init(),t.field_focus&&this.formEl.querySelector(`[name=${t.field_focus}]`).focus()):400===e.status&&(this.formEl.innerHTML=t.html)}async handle_post_comment_response(e){const t=await e.json();200===e.status?(this.formWrapperEl.innerHTML=t.html,this.init(),t.field_focus&&this.formEl.querySelector(`[name=${t.field_focus}]`).focus()):201===e.status||202===e.status||400===e.status?this.formEl.innerHTML=t.html:e.status>400&&alert("Something went wrong and your comment could not be processed. Please, reload the page and try again.")}}class ReplyFormsHandler{constructor(e,t){this.replyFormBase=document.querySelector(e),this.replyMap=new Map;const i=window.dci.page_param||"cpage";for(const n of document.querySelectorAll(t)){const e=n.querySelector("form");if(null===e)return void console.error(`Could not find a reply form within one of the elements retrieved with ${t}.`);const s=e.elements.reply_to.value,o=e.elements[i]?e.elements[i].value:null,l=this.replyFormBase.cloneNode(!0);l.dataset.dci=`reply-form-${s}`;const r=l.querySelector("form");r.elements.reply_to.value=s,o&&(r.elements[i].value=o);const a=n.parentNode;n.replaceWith(l),this.init(s),this.replyMap.set(s,a)}}init(e,t){const i=`[data-dci=reply-form-${e}]`,n=document.querySelector(i),s=n.querySelector("form");s.elements.post.addEventListener("click",this.send_clicked(e));s.elements.preview.addEventListener("click",this.preview_clicked(e));s.elements.cancel.addEventListener("click",this.cancel_clicked(e)),s.style.display="none";const o=n.querySelector("[data-dci=reply-textarea]");o.querySelector("textarea").addEventListener("focus",this.textarea_focus(e)),!0===t&&(n.classList.add("active"),o.style.display="none",s.style="",s.elements.comment.focus())}get_map_item(e){const t=this.replyMap.get(e);if(void 0===t){const t=`replyMap doesn't have a key ${e}`;throw console.error(t),t}return t}disable_buttons(e,t){e.elements.post.disabled=t,e.elements.preview.disabled=t}is_valid(e){for(const t of e.querySelectorAll("[required]"))if(!t.reportValidity())return t.focus(),!1;return!0}textarea_focus(e){return t=>{const i=this.get_map_item(e),n=`[data-dci=reply-form-${e}`,s=i.querySelector(n),o=s.querySelector("form"),l=s.querySelector("[data-dci=reply-textarea]");s.classList.toggle("active"),l.style.display="none",o.style="",o.elements.comment.focus()}}cancel_clicked(e){return t=>{const i=this.get_map_item(e),n=`[data-dci=reply-form-${e}`,s=i.querySelector(n),o=s.querySelector("form"),l=s.querySelector("[data-dci=reply-textarea]"),r=o.elements.comment.value;l.querySelector("textarea").value=r,s.classList.toggle("active"),o.style.display="none",l.style="";const a=i.querySelector("[data-dci=preview]");a&&a.remove()}}preview_clicked(e){return t=>{this.post("preview",e)}}send_clicked(e){return t=>{this.post("post",e)}}post(e,t){const i=this.get_map_item(t),n=i.querySelector("form");if(!this.is_valid(n))return;this.disable_buttons(n,!0);const s=i.querySelector("[data-dci=preview]");s&&s.remove();const o=new FormData(n);return void 0!==e&&o.append(e,1),fetch(n.action,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:o}).then((i=>{"preview"===e?this.handle_preview_comment_response(i,t):"post"===e&&this.handle_post_comment_response(i,t)})),this.disable_buttons(n,!1),!1}handle_http_200(e,t,i){e.innerHTML=t.html,this.init(i,!0),t.field_focus&&e.querySelector(`[name=${t.field_focus}]`).focus()}handle_http_201_202_400(e,t){e.querySelector("form").innerHTML=t.html}async handle_preview_comment_response(e,t){const i=this.get_map_item(t),n=await e.json();200===e.status?this.handle_http_200(i,n,t):400===e.status&&this.handle_http_201_202_400(i,n)}async handle_post_comment_response(e,t){const i=this.get_map_item(t),n=await e.json();200===e.status?this.handle_http_200(i,n,t):201===e.status||202===e.status||400===e.status?this.handle_http_201_202_400(i,n):e.status>400&&alert("Something went wrong and your comment could not be processed. Please, reload the page and try again.")}}class FoldingHandler{constructor(e){this.dir=e,this.target_comment=void 0,this.comment_replies=-1;const t=`[data-dci-action=${this.dir}]`,i=document.querySelectorAll(t),n=this.on_click.bind(this);i.forEach((t=>{"fold"===e&&t.classList.remove("hide"),t.addEventListener("click",n)}))}on_click(e){e.preventDefault(),this.target_comment=e.target.closest(".comment").parentNode,this.comment_replies=parseInt(e.target.dataset.dciReplies),this.fold_or_unfold_siblings();const t=this.target_comment.getAttribute("id").split("-");console.assert(2===t.length&&"comment"===t[0]);const i=parseInt(t[1]);this.turn_links(i)}turn_links(e){const t=`${this.dir}-${e}`,i=document.getElementById(t);null!==i&&i.classList.add("hide");const n=("fold"===this.dir?"unfold":"fold")+`-${e}`,s=document.getElementById(n);null!==s&&s.classList.remove("hide")}fold_or_unfold_siblings(){let e=0,t=this.target_comment.nextElementSibling;for(;t&&e<this.comment_replies;){const i=t.getAttribute("id").split("-");if(3!==i.length||"reply"!==i[0]||"to"!==i[1]){if(2===i.length&&"comment"===i[0]){const n=parseInt(i[1]),s=`reply-to-${n}`,o=document.getElementById(s);o&&this.toggle(o),this.turn_links(n),this.toggle(t),t=t.nextElementSibling,e++}}else t=t.nextElementSibling}}toggle(e){"fold"===this.dir?e.classList.add("hide"):"unfold"===this.dir&&e.classList.remove("hide")}}function init_comments(){if(null===window.dci)return;if(void 0===window.dci.page_param){const e=document.querySelector("[data-dci=config]");e&&(window.dci.page_param=e.getAttribute("data-page-qs-param"))}window.dci.comment_form=null,window.dci.reply_forms_handler=null,window.dci_folding_handler=null,window.dci_unfolding_handler=null;const e="[data-dci=comment-form]";null===window.dci.comment_form&&document.querySelector(e)&&(window.dci.comment_form=new CommentForm(e));const t="[data-dci=reply-form-template]",i="[data-dci=reply-form]";null===window.dci.reply_forms_handler&&document.querySelector(t)&&document.querySelectorAll(i)&&(window.dci.reply_forms_handler=new ReplyFormsHandler(t,i)),window.dci.folding_handler=new FoldingHandler("fold"),window.dci.unfolding_handler=new FoldingHandler("unfold")}class ReactionsPanel{constructor({panel_el:e,is_guest:t,login_url:i,react_url:n}=opts){this.panel_el=e,this.arrow_el=e.querySelector(".arrow"),this.is_guest=t,this.login_url=i,this.react_url=n,this.panel_title="",this.panel_title_elem=this.panel_el.querySelector(".title"),this.panel_title_elem&&(this.panel_title=this.panel_title_elem.textContent),this.comment_id=0,this.next_url="",this.on_react_btn_click=this.on_react_btn_click.bind(this),this.on_react_btn_mouseover=this.on_react_btn_mouseover.bind(this),this.on_react_btn_mouseout=this.on_react_btn_mouseout.bind(this),this.add_event_listeners()}add_event_listeners(){const e=this.panel_el.querySelectorAll("BUTTON");for(const t of Array.from(e))t.addEventListener("click",this.on_react_btn_click),t.addEventListener("mouseover",this.on_react_btn_mouseover),t.addEventListener("mouseout",this.on_react_btn_mouseout)}on_react_btn_click(e){if(this.is_guest)window.location.href=`${this.login_url}?next=${this.next_url}`;else{const t=e.target.dataset.code,i=this.react_url.replace("0",this.comment_id),n=new FormData;n.append("reaction",t),n.append("csrfmiddlewaretoken",function get_cookie(e){let t=null;if(document.cookie&&""!==document.cookie){const i=document.cookie.split(";");for(let n=0;n<i.length;n++){const s=i[n].trim();if(s.substring(0,e.length+1)===e+"="){t=decodeURIComponent(s.substring(e.length+1));break}}}return t}("csrftoken")),fetch(i,{method:"POST",cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},body:n}).then((e=>this.handle_reactions_response(e)))}}async handle_reactions_response(e){const t=await e.json();if(200===e.status||201===e.status){const e=`#cm-reactions-${this.comment_id}`,i=document.querySelector(e);i&&(i.innerHTML=t.html)}else e.status>400&&alert("Something went wrong and your comment reaction could not be processed. Please, reload the page and try again.")}on_react_btn_mouseover(e){this.panel_title_elem&&(this.panel_title_elem.textContent=e.target.dataset.title)}on_react_btn_mouseout(e){this.panel_title_elem.textContent=this.panel_title}set_position(e){this.panel_el.style.display="block";const t=this.get_absolute_coords(this.panel_el),i=this.get_absolute_coords(e),n=t.width,s=t.height,o=t.top,l=t.left,r=i.width,a=i.top,c=i.left,d=c-l+(r/2-n/2),_=a-o-s-8,h=_+10;if(this.panel_el.dataset.fromLeft=d,this.panel_el.dataset.fromTop=h,this.panel_el.dataset.left=d,this.panel_el.dataset.top=_,this.arrow_el){let e=0;e=r/2+c-(d+l);const t=`translate3d(${e}px, 0px, 0)`;this.arrow_el.style.transform=t}}hide(){clearTimeout(this.enter_delay_timeout),this.exit_delat_timeout=setTimeout((()=>{if(this.panel_el){const e=`translate3d(${this.panel_el.dataset.fromLeft}px, ${this.panel_el.dataset.fromTop}px, 0)`;this.panel_el.style.transform=e,this.panel_el.style.opacity=0,this.panel_el.style.display="none",this.panel_el.style.zIndex=0}}),0)}show(e,t){this.comment_id=t,this.next_url=e.dataset.loginNext||"",this.panel_el.style.transform="none",this.set_position(e),this.enter_delay_timeout=setTimeout((()=>{const e=`translate3d(${this.panel_el.dataset.left}px, ${this.panel_el.dataset.top}px, 0)`;this.panel_el.style.zIndex=1,this.panel_el.style.display="block",this.panel_el.style.transform=e,this.panel_el.style.opacity=1}),0)}get_absolute_coords(e){if(!e)return;const t=e.getBoundingClientRect(),i=window.pageXOffset,n=window.pageYOffset;return{width:t.width,height:t.height,top:t.top+n,right:t.right+i,bottom:t.bottom+n,left:t.left+i}}}class ReactionsHandler{constructor(e){if(this.cfg_el=e,this.is_guest="1"===this.cfg_el.getAttribute("data-guest-user"),this.login_url=this.init_login_url(),this.react_url=this.init_react_url(),this.links=document.querySelectorAll("[data-dci=reactions-panel]"),0===this.links.length)throw new Error("Cannot initialize reactions panel => There are no elements with [data-dci=reactions-panel].");this.active_visible_panel=0,this.panels_visibility=new Map,this.event_handlers=[],this.add_event_listeners(),this.listen_to_click_on_links();if(this.panel_el=document.querySelector("[data-dci=reactions-panel-template]"),void 0===this.panel_el)throw new Error("Cannot find element with ${qs_panel}.");const t={panel_el:this.panel_el,is_guest:this.is_guest,login_url:this.login_url,react_url:this.react_url};this.reactions_panel=new ReactionsPanel(t)}init_login_url(){const e=this.cfg_el.getAttribute("data-login-url");if((null===e||0===e.length)&&this.is_guest)throw new Error("Cannot initialize reactions panel => The [data-login-url] attribute does not exist or is empty.");return e}init_react_url(){const e=this.cfg_el.getAttribute("data-react-url");if(null===e||0===e.length){if(!this.is_guest)throw new Error("Cannot initialize reactions panel => The [data-react-url] attribute does not exist or is empty.");console.info("Couldn't find the data-react-url attribute, but the user is anonymous. She has to login first in order to post comment reactions.")}return e}on_document_click(e){const t=e.target.getAttribute("data-dci");t&&"reactions-panel"===t||(this.reactions_panel.hide(),this.active_visible_panel&&(this.panels_visibility.set(this.active_visible_panel,!1),this.active_visible_panel=0))}on_document_key_up(e){"Escape"===e.key&&(this.reactions_panel.hide(),this.active_visible_panel&&(this.panels_visibility.set(this.active_visible_panel,!1),this.active_visible_panel=0))}add_event_listeners(){const e=this.on_document_click.bind(this),t=this.on_document_key_up.bind(this);window.document.addEventListener("click",e),window.document.addEventListener("keyup",t),this.event_handlers.push({elem:window.document,event:"click",handler:this.on_document_click}),this.event_handlers.push({elem:window.document,event:"keyup",handler:this.on_document_key_up})}remove_event_listeners(){for(const e of this.event_handlers)e.elem.removeEventListener(e.event,e.handler)}listen_to_click_on_links(){for(const e of Array.from(this.links)){const t=e.getAttribute("data-comment");if(null===t)continue;const i=this.toggle_reactions_panel(t);e.addEventListener("click",i),this.event_handlers.push({elem:e,event:"click",handler:i}),this.panels_visibility.set(t,!1)}}toggle_reactions_panel(e){return t=>{t.preventDefault();const i=this.panels_visibility.get(e);i?(this.active_visible_panel=0,this.reactions_panel.hide()):(this.active_visible_panel=e,this.reactions_panel.show(t.target,e)),this.panels_visibility.set(e,!i)}}}function init_reactions(){if(null===window.dci)return;const e=document.querySelector("[data-dci=config]");null!==e&&null!==window.dci&&(window.dci.reactions_handler=null,null===window.dci.reactions_handler&&(window.dci.reactions_handler=new ReactionsHandler(e),window.addEventListener("beforeunload",(e=>{window.dci.reactions_handler.remove_event_listeners()}))))}window.dci.init_comments=init_comments,window.dci.init_reactions=init_reactions,window.addEventListener("DOMContentLoaded",(e=>{null!==window.dci&&(init_comments(),init_reactions())}))})();
//# sourceMappingURL=dci-0.1.0.min.js.map